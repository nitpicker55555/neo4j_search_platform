<head xmlns="http://www.w3.org/1999/html">
    <style> body { margin: 0; }
    #node-caption {
        position: absolute;
        display: none;
        z-index: 100;
    }
    #node-picture {
        position: absolute;
        display: none;
        z-index: 100;
    }
    #paralle{
        position: absolute;
        display: none;
        z-index: 999;
    }
    .span-container {
        position: absolute;
        top: 10px;
        z-index: 999;
        right: 10px;
        width: 200px; /* 可根据需要调整容器宽度 */
        word-wrap: break-word;
        display: inline-block;
        white-space: pre-line;
        font-style: italic;
        font-size: small;
    }
    #svg-span{
        position: absolute;
        top: 10px;
        z-index: 999;
        right: 10px;
        width: 200px; /* 可根据需要调整容器宽度 */
    }
    .bold {
        font-weight: bold;
    }
    .normal {
        font-style: normal;
    }
    .checkbox-container {
        position: absolute;
        display: flex;
        z-index: 999;
        justify-content: center;
        top: 50px;
        left: 0px;

    }
    /* Checkbox与标签排列 */
    .checkbox-item {
        z-index: 999;
        margin-right: 15px;


    }
    #Caption{
        position: absolute;
        font-style: italic;
        font-weight: bold;
        z-index: 999;
        top: 10px;
    }
    #result{
        /*position: absolute;*/
        font-style: italic;
        z-index: 999;
        /*top: 40px;*/
        /*left: 480px;*/
        font-size: small;
    }
    .fullscreen-svg {
        width: 100vw;   /* 视口宽度 */
        height: 100vh;  /* 视口高度 */
        position: absolute;
        top: 0;
        left: 0;
        z-index: 1;
    }
    #3d-graph {
        width: 1000px;   /* 视口宽度 */
        height: 1000px;  /* 视口高度 */
        position: absolute;
        top: 0;
        left: 0;
        z-index: 1;
    }

    #label_check{
        position: absolute;
        /*font-style: italic;*/
        z-index: 999;
        top: 10px;
        left: 340px;
        font-size: small;
    }
    #myCheckbox{
        position: absolute;
        z-index: 999;
        top: 10px;
        left: 450px;
    }

    #ai-caption {
        margin-right: 0px; /* 调整这个值以改变距离 */
    }

    /*#ai-caption {*/
    /*    margin-right: 20px; !* space between ai-caption and ai_dropdown *!*/
    /*}*/

    #ai_dropdown {
        margin-left: 0px; /* space between ai_dropdown and searchInput */
    }



    #suggestions{
        position: absolute;
        z-index: 999;
        left: 280px;
        top: 71px;
        max-height: 250px;  /* 或者您希望的任何其他高度 */
        overflow-y: auto;  /* 当内容超出容器时，垂直方向上允许滚动 */
        border: 1px solid #ccc; /* 可选：为下拉菜单添加边框 */
        width: 200px; /* 可选：设置下拉菜单的宽度，或者使其与输入框宽度相匹配 */
        box-shadow: 0 4px 8px rgba(0,0,0,0.1); /* 可选：为下拉菜单添加轻微的阴影 */

    }
    .element-group {
        position: absolute;
        left: 10px;
        z-index: 999;
        display: flex;
        align-items: center;
        width: 100px;
        top: 100px;
        /* other styles as needed... */
    }
    .link { stroke: #999; stroke-opacity: 0.6; }
    /*#ai_dropdown {*/
    /*    width: 200px;*/
    /*    margin-right: 20px; !* space between ai_dropdown and searchInput *!*/
    /*}*/
    #attribute_dropdown {
        width: 200px;
        margin-right: 20px; /* space between ai_dropdown and searchInput */
    }

    /*#plus_button{*/
    /*    left: 600px;*/
    /*    position: absolute;*/
    /*    z-index: 999;*/
    /*    top: 40px;*/

    /*}*/

    table {
        border-collapse: collapse;  /* this is necessary for borders to collapse into one */
        border: 1px solid black;
    }
    th, td {
        border: 1px solid black;
        padding: 8px;  /* for padding inside cells */
    }
    th {
        background-color: #f2f2f2;  /* light gray background for headers */
    }

    #details{
        left: 10px;
        position: absolute;
        z-index: 999;

    }
    .duplicated {
        left: 400px;  /* Original 100px + 300px */
    }
    .suggestion-item {
        padding: 8px;
        cursor: pointer;
    }

    .suggestion-item:hover {
        background-color: #eee;
    }

    iframe {
        border: none;

    }
    </style>
    <script src="https://unpkg.com/three"></script>
    <script src="https://unpkg.com/@seregpie/three.text-texture"></script>
    <script src="https://unpkg.com/@seregpie/three.text-sprite"></script>
    <script src="https://unpkg.com/3d-force-graph@1.73.2/dist/3d-force-graph.min.js"></script>
    <script src="https://unpkg.com/neo4j-driver"></script>
    <script src="https://unpkg.com/neovis.js@2.0.2"></script>
    <script src="https://d3js.org/d3.v6.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>

    <!--<script src="../../dist/3d-force-graph.js"></script>-->
</head>
<title>3D Knowledge Graph Platform</title>
<body>
<input type="text" id="node-caption" />
<!--<svg id="dpp"></svg>-->
<!--<div id="suggestions2"></div>-->
<div id="3d-graph"></div>


<iframe id="paralle" src="{{ url_for('iframe_page') }}"></iframe>
<!--<iframe id="paralle" ></iframe>-->

<label id="Caption">AI ethics visual analysis platform</label>

<div class="checkbox-container">

    <div class="checkbox-item">
        <input type="checkbox" id="check3d">
        <label for="check3d">3D</label>
        <button id="plus_button">+</button>
        <button id="minus_button">-</button>
        <label  id="result">1 Case found</label>
        <button id="btn_similarity">Similarity</button>
        <button id="all_lines">Parallel Coordinate Plot</button>
        <button onclick="location.href='/second'">Add data</button>

        <button id="del_btn">Del data</button>

    </div>
<!--    <form action="/second",class="checkbox-item">-->
<!--        -->
<!--    </form>-->


</div>
<div class="span-container">

    <span id="my-span">...</span>

</div>
<svg id='svg-span' width="300" height="300"></svg>
<div class="element-group">
    <label for="ai_dropdown" id="ai-caption">Label:</label>
    <select id="ai_dropdown">
        <option value="AI Ethics" selected>Select labels</option>
    </select>
    <select id="attribute_dropdown">
        <option value="AI Ethics" selected>Select labels</option>
    </select>
    <!--    <input type="text" id="searchInput" placeholder="Search in label"/>-->

</div>




<table id="dataTable">
    <thead>
    <tr>
        <th>Node Label_Index</th>
        <th>Node Caption</th>
    </tr>
    </thead>
    <tbody>
    <!-- Rows will be added here dynamically -->
    </tbody>
</table>


<!--<div id="suggestions"></div>-->

<script>
    var dict_level = {};
    var dict_nodes={}
    var global_nodes=[]
    var global_links=[]
    fetch('http://127.0.0.1:5002/post_level')
        .then(response => response.json())
            .then(data => {
                dict_level = data.reply;
                console.log('dict_level:', dict_level);
            })
            .catch(error => console.error('Error fetching data:', error));

    const checkbox_3d=document.getElementById('check3d')
    var svg_num=0
    var global_index_list=[]
    let isQueryRunning = false; // 标志来跟踪查询状态
    var listener_list =[]
    let clickCount = 0;  // To keep track of how many times the button has been clicked

    document.getElementById('plus_button').addEventListener('click', function() {
        // Increment the click count
        clickCount++;

        // var totalChildNodes = document.body.childNodes.length;

// 获取 document.body 的子元素总数，仅包括元素节点
        var totalChildElements = document.body.children.length;
        if (checkbox_3d.checked) {
            clickCount=totalChildElements-7
        }else {
            clickCount=totalChildElements-8
        }

        // console.log("Total child nodes: " + totalChildNodes);
        console.log("Total child elements: " + totalChildElements);
        console.log('clickCount'+clickCount)
        // Clone the original element group
        const original = document.querySelector('.element-group');
        const clone = original.cloneNode(true);
        var top_var =document.querySelector('.element-group').getBoundingClientRect();
        // var rect = element.getBoundingClientRect();

        // 获取文档的垂直滚动距离
        var scrollTop = window.pageYOffset || document.documentElement.scrollTop || document.body.scrollTop || 0;

        // 计算元素的顶部位置相对于文档的顶部的距离
        var top = top_var.top + scrollTop;
        console.log('top_var'+top)
        // Set the left position of the clone and the button based on the click count
        clone.style.top = (top + 50 * clickCount) + "px";
        // this.style.left = (600 + 500 * clickCount) + "px";  // Move the button
        // document.getElementById('result').style.left= (480 + 500 * clickCount) + "px";

        // Append the cloned group to the body or another container
        const originalChildren = original.querySelectorAll('[id]');
// 获取克隆元素的所有子元素
        const clonedChildren = clone.querySelectorAll('[id]');

// 遍历所有子元素并更新克隆元素的 id
        originalChildren.forEach((originalChild, index) => {
            const clonedChild = clonedChildren[index];
            const newId = originalChild.id + '_clone'+clickCount.toString();
            clonedChild.id = newId;
            // 现在 clonedChild 有了一个新的唯一 id
        });


        document.body.appendChild(clone);
        // 选择所有的 select 元素
        add_listener();


    });
    document.getElementById('minus_button').addEventListener('click', function() {
        // Increment the click count
        var totalChildElements = document.body.children.length;
        var lastChild = document.body.lastChild;

// 从 document.body 中移除这个子节点
        if (checkbox_3d.checked) {
            if (totalChildElements>8){
                document.body.removeChild(lastChild);
            }
        }else {
            if (totalChildElements>9){
                document.body.removeChild(lastChild);
            }
        }


    });
    // console.log(getNumber,"asd")


    const elem = document.getElementById('3d-graph');
    elem.style.zIndex=1;
    const driver = neo4j.driver("bolt://localhost", neo4j.auth.basic("neo4j", "12345678"),{encrypted: false});
    const all_col_name=['Index', 'Case theme', 'Fields', 'Users', 'Provider', 'Influencer', 'Results', 'Reason', 'Positionalattribute', 'Opinion', 'Attitude', 'Response', 'Description', 'Place', 'Time', 'URL', 'degree of influence', 'Data acquisition', 'Data access', 'Data modeling', 'Behavior tracking', 'Behavior prediction', 'Behaviour nudging', 'Wrong user group', 'Wrong user task', 'Surprising learning result', 'Positive design that produces negative results that do not meet expectations', 'Negative design that produces negative results that meet expectations', 'Overly human-like and leading to ethics problems', 'Not human-like enough to cause ethics problems', 'Not enough beyond human to cause ethics problems', 'ethics issues caused by the wrong user group', 'ethics issues due to wrong user tasks', 'Infringements on human rights', 'Social detriment', 'Emotional or psychological injury', 'Loss of opportunity', 'Physical injury', 'Economic loss', 'Transparency', 'Justice and fairness', 'Privacy', 'Trust', 'Non-maleficence', 'Responsibility']
    const session2 = driver.session({database:"neo4j"});
    var session_attribute = driver.session({database:"neo4j"});

    session2.run("CALL db.labels()")
        .then(function(result) {
            var dropdown = document.getElementById('ai_dropdown'); // if this returns null, the next line will throw an error
            // dropdown.add(option);
            // console.log(result)
            result.records.forEach(function(record) {
                if (all_col_name.includes( record.get(0))){
                    var option = document.createElement('option');
                    option.value = record.get(0);
                    option.text = record.get(0);
                    dropdown.add(option);
                }

            });

            // Close the session and driver
            session2.close();
            // driver.close();

        }).catch(error => {
        console.error(error);
    });
    query_max_index()//initialize all cases
    const start = new Date()
    var iframe = document.getElementById("paralle");
    iframe.scrolling="no";
    document.body.appendChild(iframe);
    iframe.style.width = '300px';
    iframe.style.height = '120px';
    var src_="";
    iframe.onclick = function() {
        window.open(src_, '_blank');
        // window.location.href = src_;
        console.log(src_); // "value2"
    }

    // const words = ["apple", "banana", "cherry", "date", "elderberry", "fig", "grape", "honeydew"];


    document.addEventListener('click', function(event) {
        console.log('Element clicked:', event.target);
        if (iframe.style.display==="block"){
            window.open(src_, '_blank');
        }

    });
    session_elem("");

    add_listener();
    // 选择所有的 select 元素
    function add_listener(){
        const selects = document.querySelectorAll('select');
        // const selects_list =Array.from(selects);
        let idList = [];

// 遍历 DOM 列表
        selects.forEach(element => {
            idList.push(element.id); // 将每个元素的 id 添加到数组中
        });
        // let need_add_list = selects.filter(item => !listener_list.includes(item));
        // listener_list.forEach(item => selects_list.delete(item));

        let need_listen_list = idList.filter(item => !listener_list.includes(item));
        listener_list.push(need_listen_list)
        console.log("selects",need_listen_list)
        console.log("listener_list",listener_list)
        need_listen_list.forEach((select, index, array) => {

            const select_dom=document.getElementById(select)
            console.log("select",select)
            if (select.startsWith('ai_dropdown')) {
                var nextId = array[index + 1];
                console.log("nextId",nextId)

                // 为符合条件的 select 元素添加事件监听器
                select_dom.addEventListener('change', (event) => {
                    // 这里是您想要执行的代码
                    var selectedOption = select_dom.options[select_dom.selectedIndex].text;
                    // var selectElement = document.getElementById("attribute_dropdown");
                    const attribute_query = `
                 MATCH (n:\`${selectedOption}\`)
                        RETURN DISTINCT n.name;
                        `;
// 更改第一个选项的文本
//         selectElement.options[0].text = "Search in "+selectedOption;
                    // document.getElementById("attribute_dropdown").selectedIndex = 0;
                    // document.getElementById('attribute_dropdown').value = "Search in "+selectedOption;
                    // if (selectedOption.toString().includes("_")){
                    //
                    // }else {
                    //
                    // }

                    console.log("attribute_query",attribute_query)
                    session_attribute.run(attribute_query)
                        .then(function(result) {
                            var dropdown = document.getElementById(nextId); // if this returns null, the next line will throw an error
                            // dropdown.add(option);
                            console.log("dropdown",dropdown,nextId)
                            // console.log(result)
                            if (dropdown) {
                                // 清空所有选项
                                dropdown.innerHTML = '';
                            }
                            result.records.forEach(function(record) {
                                var option = document.createElement('option');
                                option.value = record.get(0);
                                option.text = record.get(0);
                                if (!option.text.endsWith("_148")){
                                    dropdown.add(option);
                                }

                            });

                            // Close the session and driver
                            // session_attribute.close();
                            // driver.close();

                        }).catch(error => {
                        console.error(error);
                    });
                    var newOption = document.createElement("option");
                    // newOption.value =  "Search in "+selectedOption;
                    // newOption.text = "Search in "+selectedOption;

// 获取 <select> 元素
//                 var selectElement = document.getElementById("attribute_dropdown");

// 将新选项添加到 <select> 的最前面
//                     document.getElementById(nextId).insertBefore(newOption, document.getElementById(nextId).firstChild);
//
// 将这个新选项设为默认选中
                    // document.getElementById(nextId).value = "Search in "+selectedOption;

                    setTimeout(delayAsyncFunction, 1000);
                });
                select_dom.style.width = '200px';
                select_dom.style.marginRight = '20px';
            }else if (select.startsWith('attribute_dropdown')){
                select_dom.addEventListener('change', (event) => {
                    update_search()
                })
            }
        });
    }

    function delayAsyncFunction() {
        update_search();
    }

    async function queryDatabase(condition) {
        var session_get_index = driver.session({database:"neo4j"});

        try {
            // 使用 await 等待查询结果
            const resultList = await session_get_index.run(condition);
            console.log("resultList", resultList); // 这里是您的列表
// 打印新列表以验证结果
//             console.log(newList);
            return resultList.records.map(function (record) {
                // 分割字符串
                var parts = record.get(0).split("_");
                // 返回分割后的最后一部分
                return parts.length > 0 ? parts[parts.length - 1] : null;
            })
        } catch (error) {
            console.error("查询数据库时出错:", error);
        } finally {
            await session_get_index.close(); // 确保在结束时关闭会话
        }
    }
    function isNumeric(str) {
        if (typeof str != "string") return false; // 只处理字符串
        return !isNaN(str) && !isNaN(parseFloat(str));
    }

    const btn_similarity = document.getElementById("btn_similarity");


    // let isHidden = false;

    btn_similarity.addEventListener("click", () => {
        fetch('http://127.0.0.1:5002/post_similarity', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ "simi": global_index_list }),
        })
            .then(response => response.json())
            .then(data =>{
                    console.log(data)
                    const simi_index_list=data
                    console.log(simi_index_list['receivedData'])
                get_index_list_return_query(simi_index_list['receivedData']);
            })
            .catch(error => {
                console.error('Error:', error);
            });


        // const elementsToHide = document.querySelectorAll('[id^="ai-caption"]');
        // elementsToHide.forEach(element => {
        //     if (isHidden) {
        //         element.style.display = "block";
        //     } else {
        //         element.style.display = "none";
        //     }
        // });
        // const selects = document.querySelectorAll('select');
        // selects.forEach(select => {
        //     if (isHidden) {
        //         select.style.display = "block";
        //     } else {
        //         select.style.display = "none";
        //     }
        // });
        // isHidden = !isHidden;
    });
    const del_btn = document.getElementById("del_btn");


    // let isHidden = false;

    del_btn.addEventListener("click", () => {
        var result = confirm("Do you want to delete data with index:\n\n\n"+global_index_list.toString()+" ?\n\n"+"Data length: "+global_index_list.length.toString());

        if (result === true) {
            // 用户点击了确认按钮
            var session_del = driver.session({database:"neo4j"});


            global_index_list.map(number => {
                session_del.run(`MATCH (n)\nWHERE n.TrueLabel CONTAINS '${number}'\nDETACH DELETE n;`)
            .then(function (result) {
                    console.log(result)
                });

            })

            fetch('http://127.0.0.1:5002/post_del', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ "del": global_index_list }),
            })
                .then(response => response.json())
                .then(data =>{


                    if (data['receivedData']==="successful"){
                        alert("Delete successfully")
                    }else {
                        alert("Delete not successfully")
                    }


                })

                .catch(error => {
                    console.error('Error:', error);
                })
            // alert("操作已执行！");
        } else {
            // 用户点击了取消按钮或者关闭了确认框

        }
  });
    function filterNumericStrings(array) {
        return array.filter(item => typeof item === 'string' && /^\d+$/.test(item));
    }
    async function update_search(){
        const selects = document.querySelectorAll('select');

// 使用 Array.from 方法将 NodeList 转换为数组
        const selectIds = Array.from(selects).map(select => select.id);

// 打印所有的 select 元素的 id
//         MATCH (n:Fields)
//         WHERE n.name = 'Autonomous Driving'
//         RETURN n.TrueLabel;

        let condition=""
        var index_lists=[]
        var num_list=[]
        // WHERE  n.TrueLabel CONTAINS "148"  and  NOT n.redundancy RETURN n.TrueLabel;
        for (const id of selectIds) {
            const index = selectIds.indexOf(id);


            let dropdown_str=document.getElementById(id).value



            if (id.startsWith('ai_dropdown')){
                if (dropdown_str.includes(' ') ||  dropdown_str.includes('-') ) {
                    condition+=`MATCH (n:\`${dropdown_str}\`)`;
                }

                else {
                    condition+=`MATCH (n:${dropdown_str})`;

                }
            }else if (id.startsWith('attribute_dropdown')){
                // console.log("document.getElementById(id).value",document.getElementById(id).textContent)
                if (isNumeric(dropdown_str)){
                    condition += `WHERE n.name = ${dropdown_str} RETURN n.TrueLabel;`;
                }else if(dropdown_str.includes("'")) {
                    condition += `WHERE n.name = "${dropdown_str}" RETURN n.TrueLabel;`;
                }

                else {

                    condition += `WHERE n.name = '${dropdown_str}' RETURN n.TrueLabel;`;
                }


                console.log("condition",condition)
                try {
                    const result = await queryDatabase(condition);
                    console.log(condition, result);

                    index_lists = findCommonElements(index_lists, result);
                    // console.log("joint list1", index_lists);
                } catch (error) {
                    console.error("在获取列表时出错:", error);
                }



                // session_get_index.run(condition)
                //     .then(resultList => {
                //         console.log("resultList",resultList); // 这里是您的列表
                //     })
                condition=""
            }

        }
        // console.log("joint list2",index_lists)
        // WHERE  n.TrueLabel CONTAINS "148"  and  NOT n.redundancy
        get_index_list_return_query(index_lists)
        // console.log("index_list",index_list)
    }

    function get_index_list_return_query(raw_index_lists){
        const index_lists = filterNumericStrings(raw_index_lists);
        let query_str = "WHERE ";
        for (const [index, value] of   index_lists.entries()) {
            // console.log(index,value)
            if (index===0){
                query_str+=` n.TrueLabel =~ \".*_${value}$\"  `
            }else {
                query_str+=` or  n.TrueLabel =~ \".*_${value}$\" `
            }

            // 在此处处理每个元素 id
        }
        query_str+=" and  NOT n.redundancy"
        // console.log(query_str)
        if (index_lists.length!==0){
            session_elem(query_str);
        }

        // console.log(condition);
        call_back_index(index_lists)
    }
    function call_back_index(index_list){

        global_index_list=index_list

        document.getElementById('result').textContent=`${global_index_list.length} Cases found`
        if (global_index_list.length===0){
            alert("No cases found.")
        }
        fetch('http://127.0.0.1:5002/post_multi', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ "multi": global_index_list }),
        })
            .then(response => response.json())
            .then(data => console.log(data));
    }
    function findCommonElements(arr1, arr2) {
        if (arr1.length===0){
            arr1=arr2

        }
        // 使用 filter 方法来找到在 arr2 中也存在的 arr1 的元素
        // console.log(arr1,arr2)
        return arr1.filter(function(element) {
            return arr2.includes(element);
        });
    }
    function get_truelabel_index(str) {
        const parts = str.split("_");
        return parts[parts.length - 1];
    }
    function updateGraph(simulation,nodeIdToRemove,links,nodes,svg) {
        // 选择并更新所有的边
        console.log(nodeIdToRemove)
        nodes = nodes.filter(function(node) {
            return node.id !== nodeIdToRemove;
        });

// 删除边
        links = links.filter(function(link) {
            return link.source.id !== nodeIdToRemove && link.target.id !== nodeIdToRemove;
        });

// 重启模拟以反映数据的更改
        simulation.nodes(nodes);
        simulation.force("link").links(links);
        simulation.alpha(1).restart();

// 更新边
        var link = svg.selectAll(".link")
            .data(links, function(d) { return d.source.id + "-" + d.target.id; });

        link.exit().remove();

        link.enter().append("line")
            .attr("class", "link");

// 更新节点
        var node = svg.selectAll(".node")
            .data(nodes, function(d) { return d.id; });

        node.exit().remove();

        var newNode = node.enter().append("g")
            .attr("class", "node");

        newNode.append("circle")
            .attr("r", 5); // 假设节点是以圆圈表示

        newNode.append("text")
            .text(function(d) { return d.id; });

// 应用拖拽行为
        newNode.call(d3.drag()
            .on("start", dragstarted)
            .on("drag", dragged)
            .on("end", dragended));

// 更新力导向图的布局
        simulation.on("tick", function() {
            link.attr("x1", function(d) { return d.source.x; })
                .attr("y1", function(d) { return d.source.y; })
                .attr("x2", function(d) { return d.target.x; })
                .attr("y2", function(d) { return d.target.y; });

            node.attr("transform", function(d) {
                return "translate(" + d.x + "," + d.y + ")";
            });
        });

// 拖拽行为的实现
        function dragstarted(d) {
            if (!d3.event.active) simulation.alphaTarget(0.3).restart();
            d.fx = d.x;
            d.fy = d.y;
        }

        function dragged(d) {
            d.fx = d3.event.x;
            d.fy = d3.event.y;
        }

        function dragended(d) {
            if (!d3.event.active) simulation.alphaTarget(0);
            d.fx = null;
            d.fy = null;
        }
    }

    function svg_span_draw(nodes,links){
        const idToColorMap = {};
        var svg = d3.select("#svg-span"),
            width = +svg.attr("width"),
            height = +svg.attr("height");
        svg.selectAll("*").remove();
        function getColorById(id) {
            // 定义颜色的起始和结束值
            const startHue = 0; // 起始色调
            const endHue = 300; // 结束色调
            const saturation = 100; // 饱和度
            const lightness = 60; // 亮度

            // 如果这个 id 已经有一个颜色，就返回这个颜色
            if (idToColorMap[id]) {
                return idToColorMap[id];
            }

            // 计算当前 id 在总共 8 个 id 中的位置
            const position = parseInt(id) / 8;

            // 计算当前 id 对应的色调
            const hue = startHue + (position * (endHue - startHue));

            // 生成 HSL 颜色
            const color = `hsl(${hue}, ${saturation}%, ${lightness}%)`;

            // 将颜色与 id 关联起来
            idToColorMap[id] = color;

            // 返回颜色
            return color;}
        var simulation = d3.forceSimulation(nodes)
            .force("link", d3.forceLink(links).id(d => d.id))
            .force("charge", d3.forceManyBody())
            .force("center", d3.forceCenter(width / 2, height / 2));

        var link = svg.append("g")
            .attr("class", "links")
            .selectAll("line")
            .data(links)
            .enter().append("line")
            .attr("class", "link");

        var node = svg.append("g")
            .attr("class", "nodes")
            .selectAll("circle")
            .data(nodes)
            .enter().append("circle")
            .attr("r", function(d) {
                // console.log(nodes.find(node => node.id === d.id).label)
                return 1/(dict_level[nodes.find(node => node.id === d.id).label])*25;
            })
            .attr("class", "node")
            .attr("fill", d => getColorById(dict_level[nodes.find(node => node.id === d.id).label])) // 为每个节点根据level设置颜色
        simulation.on("tick", () => {
            link.attr("x1", d => d.source.x)
                .attr("y1", d => d.source.y)
                .attr("x2", d => d.target.x)
                .attr("y2", d => d.target.y);

            node.attr("cx", d => d.x)
                .attr("cy", d => d.y);
            var minX = d3.min(nodes, d => d.x),
                minY = d3.min(nodes, d => d.y),
                maxX = d3.max(nodes, d => d.x),
                maxY = d3.max(nodes, d => d.y);
            // console.log(minX)
            // 计算视图框大小和位置
            var viewBoxX = minX,
                viewBoxY = minY,
                viewBoxWidth = maxX - minX,
                viewBoxHeight = maxY - minY;

            // 为了确保内容完全可见，可以留出一点边距
            var margin = 10;
            svg.attr("viewBox", `${viewBoxX - margin} ${viewBoxY - margin} ${viewBoxWidth + 2 * margin} ${viewBoxHeight + 2 * margin}`);

        });

    }
    function two_d(nodes, links) {
        // console.log(nodes,"nodes")
        // console.log(links,"links")
        const idToColorMap = {};
        // 设置 SVG 尺寸
        const width = window.innerWidth;
        const height = window.innerHeight;


        update_row(nodes);

        // // 创建 SVG 容器
        let svg = d3.select("body").select("svg.fullscreen-svg");
        // let svgs = d3.select("2dsvg")

        d3.select("body").selectAll("svg").remove(); //remove old elements


        svg = d3.select("body").append("svg")
            .attr("class", "fullscreen-svg") // 添加类名以便使用 CSS 设置样式
            // .attr("pointer-events", "all") // 确保 SVG 可以捕捉鼠标事件.
            //     .attr("width", "100%") // 假设你想要 SVG 充满其容器
            //     .attr("height", "100%")
            .call(d3.zoom().on("zoom", zoomed)) // 添加缩放行为
            .append("g");
        // let svgRect = svg.getBoundingClientRect();
        let table_head=document.getElementById('dataTable')
        // let table = document.querySelector("#dataTable tbody");
        //
        table_head.style.position = 'absolute';
        table_head.style.top = '100vh'; // 设置表格的顶部位置在视口高度之外
        table_head.style.zIndex = 2; // 确保表格在SVG之上
        // const container = svg.append("g");
        // const svg = d3.select("#3d-graph")
        //     .attr("width", "100%") // 假设你想要 SVG 充满其容器
        //     .attr("height", "100%")
        //     .attr("pointer-events", "all") // 确保 SVG 可以捕捉鼠标事件.
        // .call(d3.zoom().on("zoom", zoomed)) // 添加缩放行为


        // 创建力导向图
        const simulation = d3.forceSimulation(nodes)
            .force("link", d3.forceLink(links).id(d => d.id))
            .force("charge", d3.forceManyBody().strength(-20))
            .force("center", d3.forceCenter(width / 2, height / 2))
            .force("collide", d3.forceCollide().radius(function(d) {
            return 40; // 根据节点大小设置碰撞半径，+2 为额外间距
        }))
        // 创建链接线
        const link = svg.append("g")
            .attr("class", "links")
            .selectAll("line")
            .data(links)
            .enter().append("line")
            .attr("stroke-width", 2)
            .attr("stroke", "grey");

        // 创建节点
        const node = svg.append("g")
            .attr("class", "nodes")
            .selectAll("circle")
            .data(nodes)
            .enter().append("g")
            // .enter().append("circle")
            .attr("r", 5)
            // .attr("fill", d => getColorById(nodes.find(node => node.id === d.id).label)) // 为每个节点设置颜色
            .call(d3.drag()
                .on("start", dragstarted)
                .on("drag", dragged)
                .on("end", dragended))
            .on("click", clicked) // 假设有一个 clicked 函数来处理点击事件
            .on("mouseover", hover_node); // 假设有一个 clicked 函数来处理点击事件



        const circles = node.append("circle")
            .attr("r", function(d) {
                // console.log(nodes.find(node => node.id === d.id).label)
                return 1/(dict_level[nodes.find(node => node.id === d.id).label])*50;
            })
            .attr("fill", d => getColorById(dict_level[nodes.find(node => node.id === d.id).label])) // 为每个节点根据level设置颜色
        // .attr("fill", d => getColorById(nodes.find(node => node.id === d.id).label)) // 为每个节点设置颜色


        // 在节点旁添加文本
        const labels = node.append("text")
            .text(d => nodes.find(node => node.id === d.id).label) // 每个节点对象有一个 'id' 属性作为名称
            .attr("x", 6)
            .attr("y", 3);



        function getColorById(id) {
            // 定义颜色的起始和结束值
            const startHue = 0; // 起始色调
            const endHue = 300; // 结束色调
            const saturation = 100; // 饱和度
            const lightness = 60; // 亮度

            // 如果这个 id 已经有一个颜色，就返回这个颜色
            if (idToColorMap[id]) {
                return idToColorMap[id];
            }

            // 计算当前 id 在总共 8 个 id 中的位置
            const position = parseInt(id) / 8;

            // 计算当前 id 对应的色调
            const hue = startHue + (position * (endHue - startHue));

            // 生成 HSL 颜色
            const color = `hsl(${hue}, ${saturation}%, ${lightness}%)`;

            // 将颜色与 id 关联起来
            idToColorMap[id] = color;

            // 返回颜色
            return color;
        }



        function clicked(event, d) {
            // 这里定义点击节点时的行为
            console.log(d.id)
            const connectionsToTargets = links.filter(link => link.source.id === d.id);
            console.log("Connections to Target Nodes:", connectionsToTargets);

            // 第二步：从这些连接中提取目标节点的ID
            const targetNodeIds = connectionsToTargets.map(link => link.target.id);
            console.log("Target Node IDs:", targetNodeIds);

            // 第三步：查找对应的目标节点数据
            const targetNodes = targetNodeIds.map(id => nodes.find(node => node.id === id));
            console.log("Target Nodes Data:", targetNodes);

            // 找出所有以点击节点为目标的连接（即该节点是target，找出所有source）
            const sourceNodes = links.filter(link => link.target === d.id)
                .map(link => {
                    // 返回源节点的完整数据
                    return nodes.find(node => node.id === link.source);
                });

            // 输出这些节点
            console.log("Target Nodes:", targetNodes);
            console.log("Source Nodes:", sourceNodes);

            // 调用updateGraph来更新图表
            updateGraph(simulation,targetNodeIds[0],links,nodes,svg);
        }
        function hover_node(event, d) {
            // 这里定义点击节点时的行为
            const nodeWithId223 = nodes.find(node => node.id === d.id);
            const true_label_index=get_truelabel_index(nodes.find(node => node.id === d.id).TrueLabel)
            // const captionOfNode223 =  : undefined;

            const title=dict_nodes["Case_theme"+"_"+true_label_index]
            const description=dict_nodes["Description"+"_"+true_label_index]
            const content="<span class='normal bold'>Index: </span>"+true_label_index+"\n\n<span class='normal bold'>Title: </span>"+title+"\n\n<span class='normal bold'>Description: </span>"+description
            document.getElementById('my-span').innerHTML=content
            //
            // 例如：在控制台打印节点的信息
            // console.log(`caption: ${nodeWithId223.caption}`+`\nlabel: ${nodeWithId223.label}`);
            // console.log();
        }

        // 节点拖动函数
        function dragstarted(event, d) {
            if (!event.active) simulation.alphaTarget(0.3).restart();
            d.fx = d.x;
            d.fy = d.y;
        }

        function dragged(event, d) {
            d.fx = event.x;
            d.fy = event.y;
        }

        function dragended(event, d) {
            if (!event.active) simulation.alphaTarget(0);
            d.fx = null;
            d.fy = null;
        }

        // 缩放函数
        function zoomed(event) {
            svg.attr("transform", event.transform);
        }

        // 更新节点和链接的位置
        simulation.on("tick", () => {
            link
                .attr("x1", d => d.source.x)
                .attr("y1", d => d.source.y)
                .attr("x2", d => d.target.x)
                .attr("y2", d => d.target.y);

            node
                .attr("transform", d => `translate(${d.x},${d.y})`);
        });
    }
    function id_node(nodes, links) {
        console.log(nodes,"nodes")
        console.log(links,"links")
        const idToColorMap = {};
        // 设置 SVG 尺寸
        const width = window.innerWidth;
        const height = window.innerHeight;

        update_row(nodes);

        // // 创建 SVG 容器
        let svg = d3.select("body").select("svg.fullscreen-svg");

        svg.selectAll("*").remove();
        // d3.select("body").selectAll("svg").remove(); //remove old elements


        svg = d3.select("body").append("svg")
            .attr("class", "fullscreen-svg") // 添加类名以便使用 CSS 设置样式
            // .attr("pointer-events", "all") // 确保 SVG 可以捕捉鼠标事件.
            //     .attr("width", "100%") // 假设你想要 SVG 充满其容器
            //     .attr("height", "100%")
            .call(d3.zoom().on("zoom", zoomed)) // 添加缩放行为
            .append("g");
        // let svgRect = svg.getBoundingClientRect();
        let table_head=document.getElementById('dataTable')
        // let table = document.querySelector("#dataTable tbody");
        //
        table_head.style.position = 'absolute';
        table_head.style.top = '100vh'; // 设置表格的顶部位置在视口高度之外
        table_head.style.zIndex = 2; // 确保表格在SVG之上
        // const container = svg.append("g");
        // const svg = d3.select("#3d-graph")
        //     .attr("width", "100%") // 假设你想要 SVG 充满其容器
        //     .attr("height", "100%")
        //     .attr("pointer-events", "all") // 确保 SVG 可以捕捉鼠标事件.
        // .call(d3.zoom().on("zoom", zoomed)) // 添加缩放行为

        // 创建力导向图
        let id_nodes=[]
        let id_list= {}
        let id_links= {}

        for (const item of nodes) {
            // console.log(item.TrueLabel);
            const label_index=get_truelabel_index(item.TrueLabel)
            if (!(label_index in id_list)){
                id_nodes.push({"TrueLabel":"id_node_"+label_index,"label":label_index,"id":label_index})
                id_list[label_index]=[]
                id_links[label_index]=[]
            }
            id_links[label_index].push(item.id)
            id_list[label_index].push(item)
        }
        const simulation = d3.forceSimulation(id_nodes)
            // .force("link", d3.forceLink(links).id(d => d.id))
            .force("charge", d3.forceManyBody().strength(-20))
            .force("center", d3.forceCenter(width / 2, height / 2))
            .force("collide", d3.forceCollide().radius(function(d) {
                return 50; // 根据节点大小设置碰撞半径，+2 为额外间距
            }))
        // 创建链接线
        // const link = svg.append("g")
        //     .attr("class", "links")
        //     .selectAll("line")
        //     .data(links)
        //     .enter().append("line")
        //     .attr("stroke-width", 2)
        //     .attr("stroke", "grey");

        // 创建节点
        const node = svg.append("g")
            .attr("class", "nodes")
            .selectAll("circle")
            .data(id_nodes)
            .enter().append("g")
            // .enter().append("circle")
            .attr("r", 5)
            // .attr("fill", d => getColorById(nodes.find(node => node.id === d.id).label)) // 为每个节点设置颜色
            .call(d3.drag()
                .on("start", dragstarted)
                .on("drag", dragged)
                .on("end", dragended))
            .on("click", clicked) // 假设有一个 clicked 函数来处理点击事件
            .on("mouseover", hover_node); // 假设有一个 clicked 函数来处理点击事件



        const circles = node.append("circle")
            .attr("r",50)
            .attr("fill", d => getColorById([id_nodes.find(node => node.id === d.id).label])) // 为每个节点根据level设置颜色
        // .attr("fill", d => getColorById(nodes.find(node => node.id === d.id).label)) // 为每个节点设置颜色


        // 在节点旁添加文本
        const labels = node.append("text")
            .text(d => id_nodes.find(node => node.id === d.id).label) // 每个节点对象有一个 'id' 属性作为名称
            .attr("x", 0)
            .attr("y", 0)
            .style("text-anchor", "middle") // 确保文本以其中心点对齐到指定的 x 位置
            .style("dominant-baseline", "central") // 垂直居中文本（对于大多数浏览器有效）
            .style("font-size", "28px"); // 设置字号大小


        function getColorById(id) {
            // 定义颜色的起始和结束值
            const startHue = 200; // 起始色调
            const endHue = 300; // 结束色调
            const saturation = 100; // 饱和度
            const lightness = 60; // 亮度

            // 如果这个 id 已经有一个颜色，就返回这个颜色
            if (idToColorMap[id]) {
                return idToColorMap[id];
            }

            // 计算当前 id 在总共 8 个 id 中的位置
            const position = parseInt(id) / 8;

            // 计算当前 id 对应的色调
            const hue = startHue + (position * (endHue - startHue));

            // 生成 HSL 颜色
            const color = `hsl(${hue}, ${saturation}%, ${lightness}%)`;

            // 将颜色与 id 关联起来
            idToColorMap[id] = color;

            // 返回颜色
            return color;
        }

        function create_new_link(list,id_list){
            const new_link=[]
            let source_index
            let target_index
            for (const item of list) {
                // console.log(item)
                // console.log(item.TrueLabel);
                source_index=(item.source)
                target_index=(item.target)
                if (id_list.includes(source_index) && id_list.includes(target_index)){
                    new_link.push(item)
                }
            }
            return new_link

        }

        function clicked(event, d) {
            // 这里定义点击节点时的行为
            console.log(d.id,"d.id")
            svg_span_draw(id_list[d.id],create_new_link(links,id_links[d.id]))

            // two_d(id_list[d.id],create_new_link(links,id_links[d.id]),svg)
            // const nodeWithId223 = id_nodes.find(node => node.id === d.id);
            // const captionOfNode223 =  : undefined;
            //
            // 例如：在控制台打印节点的信息
            // console.log(`caption: ${nodeWithId223.caption}`+`\nlabel: ${nodeWithId223.label}`);
            // console.log();
        }
        function hover_node(event, d) {
            // 这里定义点击节点时的行为
            const nodeWithId223 = id_nodes.find(node => node.id === d.id);
            const true_label_index=get_truelabel_index(id_nodes.find(node => node.id === d.id).TrueLabel)
            // const captionOfNode223 =  : undefined;

            const title=dict_nodes["Case_theme"+"_"+true_label_index]
            const description=dict_nodes["Description"+"_"+true_label_index]
            const content="<span class='normal bold'>Index: </span>"+true_label_index+"\n\n<span class='normal bold'>Title: </span>"+title+"\n\n<span class='normal bold'>Description: </span>"+description
            document.getElementById('my-span').innerHTML=content
            //
            // 例如：在控制台打印节点的信息
            // console.log(`caption: ${nodeWithId223.caption}`+`\nlabel: ${nodeWithId223.label}`);
            // console.log();
        }

        // 节点拖动函数
        function dragstarted(event, d) {
            if (!event.active) simulation.alphaTarget(0.3).restart();
            d.fx = d.x;
            d.fy = d.y;
        }

        function dragged(event, d) {
            d.fx = event.x;
            d.fy = event.y;
        }

        function dragended(event, d) {
            if (!event.active) simulation.alphaTarget(0);
            d.fx = null;
            d.fy = null;
        }

        // 缩放函数
        function zoomed(event) {
            svg.attr("transform", event.transform);
        }

        // 更新节点和链接的位置
        simulation.on("tick", () => {

            node
                .attr("transform", d => `translate(${d.x},${d.y})`);
        });
    }
    function update_row(nodes){//更细列表函数
        const tableBody = document.querySelector("#dataTable tbody");
        dict_nodes={}
        tableBody.innerHTML = "";
        nodes.forEach(node => {
            // console.log(node)


            const row = document.createElement('tr');

            const labelCell = document.createElement('td');
            labelCell.textContent = node.TrueLabel;

            const captionCell = document.createElement('td');
            captionCell.textContent = node.caption;
            dict_nodes[node.TrueLabel]= node.caption
            if (node.caption.toString().replace(/ /g,'_')!==node.TrueLabel.toString().split("_").slice(0, -1).join("_")){//不显示boolean数值
                row.appendChild(labelCell);
                row.appendChild(captionCell);
                tableBody.appendChild(row);
            }


            // const sprite = new THREE.TextSprite({
            //     fontSize:5, // 适当调整
            //     color: 'white',
            //     text: node.label +"  :  "+ node.caption,
            // });

            // const group = new THREE.Group();
            // group.add(sprite);
            // return group;
        })
    }
    let all_lines_button = document.getElementById("all_lines");


    all_lines_button.addEventListener("click", function() {
        // iframe.style.display="block"

        // iframe.src = "{{ url_for('iframe_page') }}" + "?param1=" + encodeURIComponent("multi") + "&param2=" + encodeURIComponent("") + "&param3=" + encodeURIComponent("small");
        src_="{{ url_for('iframe_page') }}" + "?param1=" + encodeURIComponent("multi") + "&param2=" + encodeURIComponent("") + "&param3=" + encodeURIComponent("big");
        // window.location.href =src_
        window.open(src_, '_blank');

    });


    function three_d(nodes, links){

        console.log(links.length+" links loaded in "+(new Date()-start)+" ms.")
        const gData = { nodes: Object.values(nodes), links: links}
        const nodeCaption = document.getElementById('node-picture');
        let mouseX = 0;
        let mouseY = 0;
        let boxX = 0;
        let boxY = 0;
        const boxOffsetX = 10;
        const boxOffsetY = 10;
        const tableBody = document.querySelector("#dataTable tbody");
        const Graph = ForceGraph3D()(elem)
            .graphData(gData)
            .nodeAutoColorBy('label')
            .nodeLabel(node => `${node.label}: ${node.caption}`)
            .onNodeHover(node => {
                if (node) {
                    //
                    // console.log("hover1")
                    var param1 = node.label;
                    var param2 = node.caption;
                    if (node.label==="Sum"){
                        iframe.style.width = '300px';
                        iframe.style.height = '120px';
                        iframe.style.backgroundColor = 'white';

                        iframe.src = "{{ url_for('iframe_page') }}" + "?param1=" + encodeURIComponent(param1) + "&param2=" + encodeURIComponent(param2) + "&param3=" + encodeURIComponent("small");
                        src_="{{ url_for('iframe_page') }}" + "?param1=" + encodeURIComponent(param1) + "&param2=" + encodeURIComponent(param2) + "&param3=" + encodeURIComponent("big");
                        // iframe.src="http://localhost:63342/3dgraph/paralle.html?param1="+node.label+"&param2="+node.caption+"&param3="+"small"
                        // src_="http://localhost:63342/3dgraph/paralle.html?param1="+node.label+"&param2="+node.caption+"&param3="+"big"
                    }
                    else {
                        // console.log("hover2")

                        //iframe.style.width = '150px';
                        //iframe.style.height = '150px';
                        //iframe.style.backgroundColor = 'transparent';
                        //iframe.src="http://localhost:63342/3dgraph/leida2.html?param1="+node.label+"&param2="+node.caption+"&param3="+"small"
                        //src_="http://localhost:63342/3dgraph/leida2.html?param1="+node.label+"&param2="+node.caption+"&param3="+"big"
                        fetch('http://127.0.0.1:5002/post_multi', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({ "multi":[ get_truelabel_index(node.TrueLabel)] }),
                        })


                        iframe.style.width = '900px';
                        iframe.style.height = '240px';
                        iframe.style.backgroundColor = 'white';

                        iframe.src = "{{ url_for('iframe_page') }}" + "?param1=" + encodeURIComponent("single") + "&param2=" + encodeURIComponent(get_truelabel_index(node.TrueLabel)) + "&param3=" + encodeURIComponent("small");
                        src_="{{ url_for('iframe_page') }}" + "?param1=" + encodeURIComponent("single") + "&param2=" + encodeURIComponent(get_truelabel_index(node.TrueLabel)) + "&param3=" + encodeURIComponent("big");
                        // iframe.src="http://localhost:63342/3dgraph/paralle.html?param1="+node.label+"&param2="+node.caption+"&param3="+"small"
                        // iframe.src=`http://localhost:63342/3dgraph/static/paralle.html?param1=AI_case&param2=${get_truelabel_index(node.TrueLabel)}&param3=small`
                        // src_="http://localhost:63342/3dgraph/paralle.html?param1="+node.label+"&param2="+node.caption+"&param3="+"big"
                        // src_=`http://localhost:63342/3dgraph/paralle.html?param1=AI_case&param2=${get_truelabel_index(node.TrueLabel)}&param3=big`
                    }

                    iframe.style.display="block"

                } else {
                    // console.log("no hover")
                    iframe.style.display="none"
                    // nodeCaption.value = "";
                }
                //nodeCaption.style.display = nodeCaption.value ? 'inline-block' : 'none';
            });

        update_row(nodes);

        document.addEventListener('mousemove', e => {
            if (Graph) {
                if (iframe.style.display==="block"){
                    const x = e.clientX + 100; // 10是文本框与鼠标的水平偏移量
                    const y = e.clientY - 230; // 10是文本框与鼠标的垂直偏移量
                    iframe.style.left = x + 'px';
                    iframe.style.top = y + 'px';
                }

            }
        });
    }
    async function query_max_index() {
        const query = 'MATCH (n:Index) RETURN n.name AS name';
        var session_get_index = driver.session({database:"neo4j"});

        try {
            // 使用 await 等待查询结果
            const resultList = await session_get_index.run(query);

            const numbers = resultList.records.map(record => parseFloat(record.get('name'))).filter(num => !isNaN(num));
            console.log("resultList", numbers); // 这里是您的列表
            call_back_index(numbers)

// 打印新列表以验证结果
//             console.log(newList);
            return  numbers.length;
        } catch (error) {
            console.error("查询数据库时出错:", error);
        } finally {
            await session_get_index.close(); // 确保在结束时关闭会话
        }
    }
    //function that pass parameters to three-d and two-d
    function session_elem(condition){
        var session = driver.session({database:"neo4j"});

        session
            // .run(
            // `MATCH (n)-->(m)
            // WHERE  n.TrueLabel CONTAINS "148" or n.TrueLabel CONTAINS "123" and  NOT n.redundancy
            // RETURN { id: id(n), label:head(labels(n)), caption:n.name } as source, { id: id(m), label:head(labels(m)), caption:m.name } as target LIMIT $limit`, {limit: neo4j.int(5000)})
            //
            .run('MATCH (n)-->(m) \n' +condition+
                '\nRETURN { id: id(n), label:head(labels(n)), caption:n.name, TrueLabel:n.TrueLabel } as source, { id: id(m), label:head(labels(m)), caption:m.name, TrueLabel:m.TrueLabel } as target LIMIT $limit', {limit: neo4j.int(500)})
            // .run("MATCH (n)\n" +
            //     "UNWIND labels(n) AS label\n" +
            //     "RETURN DISTINCT label\n")
            .then(function (result) {

                console.log("result",result)
                const nodes = {}
                const links = result.records.map(r => {
                    var source = r.get('source');source.id = source.id.toNumber();
                    nodes[source.id] = source;
                    var target = r.get('target');target.id = target.id.toNumber();
                    nodes[target.id] = target;
                    return {source:source.id,target:target.id}
                });

                session.close();

                global_links=links
                global_nodes=nodes


                // three_d()

                checkbox_3d.addEventListener('change', function () {
                    var labels = document.getElementsByTagName('label');
                    if (checkbox_3d.checked) {

                        for(var i = 0; i < labels.length; i++) {
                            labels[i].style.color = 'white';
                        }
                        // 启用 .nodeThreeObject 属性
                        d3.select("body").selectAll("svg").remove();
                        three_d(Object.values(nodes), links)
                    } else {
                        for(var i = 0; i < labels.length; i++) {
                            labels[i].style.color = 'black';
                        }
                        // 禁用 .nodeThreeObject 属性
                        document.getElementById('3d-graph').innerHTML = '';

                        two_d( Object.values(nodes), links);
                    }
                });
                if (checkbox_3d.checked) {
                    // 启用 .nodeThreeObject 属性
                    three_d(Object.values(nodes), links)
                } else {
                    // 禁用 .nodeThreeObject 属性
                    // id_node( Object.values(nodes), links);

                    two_d( Object.values(nodes), links);
                }




            })
            .catch(function (error) {
                    console.log(error);
                }
            );
    }

</script>
</body>