<!DOCTYPE html>
<html>
<head>
  <title>Update new case</title>
  <style>
    .form-frame {
      border: 1px solid #ddd;
      padding: 15px;
      margin-bottom: 20px;
    }
    .form-row {
      display: flex;
      flex-wrap: wrap;
      margin-bottom: 10px;
    }
    .form-group {
      display: flex;
      flex-direction: column;
      margin-right: 10px;
      margin-bottom: 10px;
      width: 22%;
    }
    .form-group label {
      margin-bottom: 5px;
    }
  </style>
  <script src="https://d3js.org/d3.v6.min.js"></script>
  <script src="https://unpkg.com/neo4j-driver"></script>
</head>
<body>

<h1>Update cases</h1>
<div id="form" class="form-frame"></div>
<button id="confirmBtn">Confirm</button>
<button id="fillBtn">Fill Text Inputs</button>
<script>
  const driver = neo4j.driver("bolt://localhost", neo4j.auth.basic("neo4j", "12345678"),{encrypted: false});
  var maxNumber=0
  // Load the CSV file
  d3.csv("/static/cases.csv").then(function(data) {
    if(data.length > 0){
      var headers = Object.keys(data[0]);
      var specialHeaders = ['degree of influence', 'Data_acquisition', 'Data_access', 'Data_modeling', 'Behavior_tracking', 'Behavior_prediction', 'Behaviour_nudging', 'Wrong_user_group', 'Wrong_user_task', 'Surprising_learning_result', 'Positive design that produces negative results that do not meet expectations', 'Negative design that produces negative results that meet expectations', 'Overly human-like and leading to ethics problems', 'Not human-like enough to cause ethics problems', 'Not enough beyond human to cause ethics problems', 'ethics issues caused by the wrong user group', 'ethics issues due to wrong user tasks', 'Infringements on human rights', 'Social detriment', 'Emotional or psychological injury', 'Loss of opportunity', 'Physical injury', 'Economic loss', 'Transparency', 'Justice and fairness', 'Privacy', 'Trust', 'Non-maleficence', 'Responsibility']; // Headers for dropdown
      var formContainer = document.getElementById('form');
      var formRow = document.createElement('div');
      formRow.className = 'form-row';

      headers.forEach(function(header, index) {
        var formGroup = document.createElement('div');
        formGroup.className = 'form-group';

        // Check if header is in the special list
        if (specialHeaders.includes(header)) {
          // Create dropdown for special headers
          formGroup.innerHTML = '<label for="' + header + '">' + (index + 1) + '. ' + header + ':</label>' +
                  '<select id="' + header + '" name="' + header + '">' +
                  '<option value="true">True</option>' +
                  '<option value="false">False</option>' +
                  '</select>';
        } else {
          // Create text input for other headers
          formGroup.innerHTML = '<label for="' + header + '">' + (index + 1) + '. ' + header + ':</label>' +
                  '<input type="text" id="' + header + '" name="' + header + '">';
        }

        formRow.appendChild(formGroup);

        // Append the row and create a new one at appropriate intervals
        if ((index + 1) % 4 === 0 || index === headers.length - 1) {
          formContainer.appendChild(formRow);
          if (index !== headers.length - 1) {
            formRow = document.createElement('div');
            formRow.className = 'form-row';
          }
        }
      });
    }
    index_fill()
  }).catch(function(error) {
    console.error('Error loading the CSV file:', error);
  });

  async function queryDatabase() {
    const query = 'MATCH (n:Index) RETURN n.name AS name';
    var session_get_index = driver.session({database:"neo4j"});

    try {
      // 使用 await 等待查询结果
      const resultList = await session_get_index.run(query);

      const numbers = resultList.records.map(record => parseFloat(record.get('name'))).filter(num => !isNaN(num));
      console.log("resultList", numbers,Math.max(...numbers)); // index start from 0

// 打印新列表以验证结果
//             console.log(newList);
      return Math.max(...numbers);
    } catch (error) {
      console.error("查询数据库时出错:", error);
    } finally {
      await session_get_index.close(); // 确保在结束时关闭会话
    }
  }
  // Function to handle Confirm button click
  document.getElementById('confirmBtn').addEventListener('click', function() {
    var inputs = document.querySelectorAll('#form input, #form select');
    var data = {};
    inputs.forEach(function(input) {
      data[input.name] = input.value;
    });
    console.log(data);

    // Send data to Flask backend
    fetch('/submit', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify(data)
    })
            .then(response => response.json())
            .then(data => {
              console.log('Success:', data);
            })
            .catch((error) => {
              console.error('Error:', error);
            });
    alert("Data added successfully")
    var textInputs = document.querySelectorAll('#form input[type="text"]');
    textInputs.forEach(function(input) {
      var label = input.previousElementSibling;
      if (label && label.tagName === 'LABEL' &&  !label.textContent.trim().startsWith('1. Index:')) {
        input.value = ""; // Remove colon and trailing spaces
      }
      if (label && label.tagName === 'LABEL' && label.textContent.trim().startsWith('1. Index:')) {
        input.value = parseInt(input.value)+1
        // input.readOnly/ = true;
      }
    });

  });
  document.getElementById('fillBtn').addEventListener('click', function() {
    var textInputs = document.querySelectorAll('#form input[type="text"]');
    textInputs.forEach(function(input) {
      var label = input.previousElementSibling;
      if (label && label.tagName === 'LABEL' &&  !label.textContent.trim().startsWith('1. Index:')) {
        input.value = label.textContent.replace(/:\s*$/, ''); // Remove colon and trailing spaces
      }
    });
  });
   function index_fill() {
     // const getNumber=  queryDatabase();
     // console.log(getNumber,"asd")
     queryDatabase().then(result => {
       maxNumber= result//

       // console.log(maxNumber)
       var inputs = document.querySelectorAll('#form input, #form select');
       inputs.forEach(function(input) {
         var label = input.previousElementSibling;
         if (label && label.tagName === 'LABEL' && label.textContent.trim().startsWith('1. Index:')) {
           input.value = maxNumber+1;
           input.readOnly = true;
         }
       })
     }).catch(error => {
       console.error('Promise rejected:', error);
     });


  }
</script>
</body>
</html>
